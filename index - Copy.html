<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>EmpireClick - 3D Kingdom</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js"></script>
    <script>
        // Fix to attach OrbitControls manually
        THREE.OrbitControls = function (...args) {
            return new window.OrbitControls(...args);
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body>
    <div class="game-container">
        <div class="world" id="world">
            <div class="ground"></div>
            <!-- Plots will be generated by JavaScript -->
        </div>
        
        <!-- Player -->
        <div class="player" id="player"></div>
        
        <!-- UI Panels -->
        <div class="ui">
            <div>💰 RevCoins: <span id="revCoinsDisplay">1000</span></div>
            <div>⚡ Per Second: <span id="perSecondDisplay">0</span></div>
            <div>📊 Total Earned: <span id="totalEarnedDisplay">0</span></div>
            <div>🏠 Plots Owned: <span id="plotsOwnedDisplay">0</span></div>
            <div>🎯 Finds Left: <span id="findsDisplay">3</span></div>
            <div>🚀 Boost: <span id="boostDisplay">0s</span></div>
            <div>🎲 Draws: <span id="drawsDisplay">0</span></div>
            <div>💰 Premium: <span id="premiumDisplay">50</span></div>
            <div>💎 Premium RevCoins: <span id="premiumRevCoinsDisplay">0</span></div>
        </div>
        
        <!-- Plot Info Panel -->
        <div id="plotInfoPanel" class="plot-info-panel" style="display: none;">
            <div>🏷️ <strong>Name:</strong> <span id="plotNameLabel">N/A</span></div>
            <div>🧍 <strong>Owner:</strong> <span id="plotOwnerLabel">N/A</span></div>
            <div>🎖️ <strong>Rarity:</strong> <span id="plotRarityLabel">N/A</span></div>
        </div>
        
        <!-- Game Panels -->
        <div class="game-panels">
            <!-- Earnings Panel -->
            <div class="panel earnings-section">
                <h3>💰 Earnings & Withdrawal</h3>
                <div class="earnings-display">
                    <div class="current-earnings">
                        <div>Current Earnings: <span id="currentEarningsDisplay">0</span></div>
                        <div>Withdrawal Balance: <span id="withdrawalBalanceDisplay">0</span></div>
                    </div>
                    <div class="earnings-rate">
                        <div>Earnings Rate: <span id="earningsRateDisplay">0</span>/sec</div>
                        <div>Base Rate: <span id="baseEarningsDisplay">0</span>/sec</div>
                    </div>
                    <div class="withdrawal-controls">
                        <button onclick="game.withdrawEarnings()">💰 Withdraw Earnings</button>
                        <button onclick="game.boostEarnings()">🚀 Boost Earnings</button>
                        <div id="withdrawalStatus">Status: Ready</div>
                        <div id="boostStatus">Boost: <span id="boostMultiplier">1.0x</span> (<span id="boostTimeLeft">0s</span>)</div>
                    </div>
                </div>
            </div>
            
            <!-- Daily Login Panel -->
            <div class="panel login-bonus-section">
                <h3>🎁 Daily Login Bonus</h3>
                <div class="login-info">
                    <div>Login Streak: <span id="loginStreakDisplay">0</span> days</div>
                    <div>Bonus Multiplier: <span id="loginBonusDisplay">1.0x</span></div>
                    <div id="loginStatus">Daily login available!</div>
                    <button onclick="game.claimDailyLogin()">🎁 Claim Daily Login</button>
                </div>
            </div>
            
            <!-- King's Draw Panel -->
            <div class="panel kings-draw-section">
                <h3>👑 King's Draw</h3>
                <div>Entries: <span id="kingsDrawEntriesDisplay">0</span></div>
                <div>Pool: <span id="kingsDrawPoolDisplay">0</span></div>
                <div>Countdown: <span id="kingsDrawCountdownDisplay">7 days</span></div>
                <button onclick="game.enterKingsDraw()">🎲 Enter Draw (100 RevCoins)</button>
                <button onclick="game.claimKingsDraw()">🏆 Claim Prize</button>
                <div class="winners-board">
                    <h4>🏆 Previous Winners</h4>
                    <div id="winnersList">No winners yet</div>
                </div>
            </div>
            
            <!-- Tax Panel -->
            <div class="panel tax-section">
                <h3>💰 Wealth Tax System</h3>
                <div>Tax Status: <span id="taxStatusDisplay">Active</span></div>
                <div>Efficiency: <span id="taxEfficiencyDisplay">100%</span></div>
                <div>Next Tax: <span id="nextTaxDisplay">6 hours</span></div>
                <button onclick="game.payTax()">💸 Pay Tax Now</button>
                <button onclick="game.boostTax()">🚀 Tax Boost</button>
                <div>Treasury Pool: <span id="treasuryPoolDisplay">0</span></div>
            </div>
            
            <!-- Takeover Panel -->
            <div class="panel takeover-section">
                <h3>⚔️ Land Takeover</h3>
                <div>Takeover Cost: <span id="takeoverCostDisplay">50</span> Premium RevCoins</div>
                <div>Available Plots: <span id="availablePlotsDisplay">0</span></div>
                <button onclick="game.initiateTakeover()">⚔️ Initiate Takeover</button>
                <button onclick="game.claimTakeover()">🏆 Claim Takeover</button>
                <div id="takeoverStatus">Status: Ready</div>
            </div>
            
            <!-- Treasury Panel -->
            <div class="panel treasury-section">
                <h3>🏛️ Treasury</h3>
                <div>Treasury Balance: <span id="treasuryBalanceDisplay">0</span></div>
                <div>Your Share: <span id="treasuryShareDisplay">0</span></div>
                <button onclick="game.claimTreasury()">💰 Claim Treasury Share</button>
                <button onclick="game.donateToTreasury()">💝 Donate to Treasury</button>
            </div>
            
            <!-- Stats Panel -->
            <div class="panel stats-panel">
                <h3>📊 Statistics</h3>
                <div>Total Plots: <span id="totalPlotsDisplay">500</span></div>
                <div>Plots Owned: <span id="plotsOwnedStatsDisplay">0</span></div>
                <div>Total Earnings: <span id="totalEarningsStatsDisplay">0</span></div>
                <div>Login Streak: <span id="loginStreakStatsDisplay">0</span> days</div>
                <div>Achievement Points: <span id="achievementPointsDisplay">0</span></div>
                <div>Current Rank: <span id="currentRankDisplay">Peasant</span></div>
                <div class="rank-progress">
                    <div>Progress to Next Rank:</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="rankProgressFill" style="width: 0%"></div>
                    </div>
                    <div id="rankProgressText">0 / 10 plots</div>
                </div>
            </div>
            
            <!-- Achievements Panel -->
            <div class="panel achievements-section">
                <h3>🏆 Achievements</h3>
                <div>Achievement Points: <span id="achievementPointsPanelDisplay">0</span></div>
                <button onclick="game.showAchievements()">🏆 View Achievements</button>
                <div id="recentAchievements">No achievements yet</div>
            </div>
            
            <!-- Leaderboard Panel -->
            <div class="panel leaderboard-section">
                <h3>🏆 Leaderboard</h3>
                <button onclick="game.showLeaderboard()">📊 View Leaderboard</button>
                <div id="topPlayers">Loading...</div>
            </div>
            
            <!-- Empire Progression Panel -->
            <div class="panel empire-progression-section">
                <h3>🏰 Empire Progression</h3>
                <div>Current Rank: <span id="empireRankDisplay">Peasant</span></div>
                <div>Next Rank: <span id="nextRankDisplay">Knight</span></div>
                <div class="rank-progress">
                    <div>Progress:</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="empireProgressFill" style="width: 0%"></div>
                    </div>
                    <div id="empireProgressText">0 / 10 plots</div>
                </div>
                <div>Rank Benefits:</div>
                <div id="rankBenefits">No benefits yet</div>
            </div>
            
            <!-- Event Panel -->
            <div class="panel">
                <h3>🔥 Current Event</h3>
                <div>Event: <span id="currentEventDisplay">None</span></div>
                <div>Time Left: <span id="eventTimerDisplay">0h 0m 0s</span></div>
                <div>Effect: <span id="eventEffectDisplay">No effect</span></div>
                <button onclick="game.watchAuditAd()" id="auditButton" style="display: none;">⚖️ Resolve Audit</button>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="controls">
            <div>WASD - Move</div>
            <div>Mouse - Look around</div>
            <div>Click plots to claim</div>
        </div>
        
        <!-- Minimize Button for Logic Panels -->
        <button id="toggleMiddleUI" onclick="toggleMiddleUIPanel()" style="position: fixed; top: 20px; left: 520px; z-index: 1001; background: rgba(0,0,0,0.8); color: white; border: 2px solid gold; border-radius: 5px; padding: 8px 12px; cursor: pointer; font-size: 12px;">🔽 Hide Info Panels</button>
        

        
        <!-- Navigation Panel -->
        <div class="navigation-panel">
            <h3>🧭 Navigation</h3>
            <div class="nav-quadrants">
                <button onclick="game.navigateToQuadrant('NW')">NW</button>
                <button onclick="game.navigateToQuadrant('NE')">NE</button>
                <button onclick="game.navigateToQuadrant('SW')">SW</button>
                <button onclick="game.navigateToQuadrant('SE')">SE</button>
            </div>
            <div class="nav-region-toggle">
                <span>Region:</span>
                <button onclick="game.toggleRegion()">Toggle</button>
            </div>
            <div class="current-region">Current: <span id="currentRegionDisplay">Default</span></div>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="explorationModal">
        <div class="modal-content">
            <h3>🔍 Plot Exploration</h3>
            <div id="explorationInfo"></div>
            <div class="exploration-info">
                <div>Plot: <span id="explorationPlotName"></span></div>
                <div>Rarity: <span id="explorationRarity"></span></div>
                <div>Current Earnings: <span id="explorationEarnings"></span>/sec</div>
                <div>Success Rate: <span id="explorationSuccessRate"></span>%</div>
                <div class="exploration-count">Explorations left: <span id="explorationCount"></span></div>
            </div>
            <div class="modal-buttons">
                <button onclick="game.explorePlot()">🔍 Explore</button>
                <button onclick="game.closeExplorationModal()">❌ Cancel</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="achievementsModal">
        <div class="modal-content achievements-modal">
            <div class="achievements-header">
                <h3>🏆 Achievements</h3>
                <button onclick="game.closeAchievementsModal()">❌ Close</button>
            </div>
            <div class="achievements-list" id="achievementsList">
                <!-- Achievements will be populated here -->
            </div>
        </div>
    </div>
    
    <div class="modal" id="leaderboardModal">
        <div class="modal-content leaderboard-modal">
            <div class="leaderboard-header">
                <h3>🏆 Leaderboard</h3>
                <button onclick="game.closeLeaderboardModal()">❌ Close</button>
            </div>
            <div class="leaderboard-list" id="leaderboardList">
                <!-- Leaderboard will be populated here -->
            </div>
        </div>
    </div>
    
    <!-- Game Message Modal -->
    <div class="game-message" id="gameMessage"></div>
    
    <script src="game.js"></script>
    <script src="ui.js"></script>
    
    <script>
      // Initialize the game
      let game;
      document.addEventListener('DOMContentLoaded', function() {
        try {
          console.log('Initializing EmpireClick game...');
          game = new EmpireClickGame();
          // Make game globally accessible
          window.game = game;
          console.log('Game initialized successfully!');
          console.log('Game instance made global:', window.game);
          console.log('Navigation functions available:', {
            navigateToQuadrant: typeof window.game.navigateToQuadrant,
            toggleRegion: typeof window.game.toggleRegion,
            applyRegionEffects: typeof window.game.applyRegionEffects
          });
          
          // Add global test function
          window.testNavigation = function() {
            if (game) {
              game.testNavigation();
            } else {
              console.error('Game not initialized!');
            }
          };
          
          // Add global manual test functions
          window.testQuadrant = function(quadrant) {
            if (game) {
              console.log(`Testing quadrant: ${quadrant}`);
              game.navigateToQuadrant(quadrant);
            } else {
              console.error('Game not initialized!');
            }
          };
          
          window.testRegion = function() {
            if (game) {
              console.log('Testing region toggle');
              game.toggleRegion();
            } else {
              console.error('Game not initialized!');
            }
          };
          
          console.log('Global test functions added:');
          console.log('- testNavigation() - Run full navigation test');
          console.log('- testQuadrant("NW") - Test specific quadrant');
          console.log('- testRegion() - Test region toggle');
          
          // Test if navigation buttons can access game
          setTimeout(() => {
            console.log('Testing navigation button access...');
            const navButtons = document.querySelectorAll('.nav-quadrants button');
            navButtons.forEach((btn, index) => {
              console.log(`Button ${index} (${btn.textContent}) onclick:`, btn.onclick);
              if (btn.onclick) {
                console.log('Button onclick function exists');
              } else {
                console.log('Button onclick function is null');
              }
            });
          }, 1000);
          
        } catch (error) {
          console.error('Error initializing game:', error);
        }
      });
      
             // 3D Model System
       const modelURLs = {
         Common: [
           'https://reddnbre.github.io/empireclick-assets/Barn.glb',
           'https://reddnbre.github.io/empireclick-assets/Cottage.glb',
           'https://reddnbre.github.io/empireclick-assets/Cabin%20Shed.glb',
           'https://reddnbre.github.io/empireclick-assets/Church.glb',
           'https://reddnbre.github.io/empireclick-assets/Elm%20tree.glb'
         ],
         Rare: 'https://reddnbre.github.io/empireclick-assets/Fortress.glb',
         Epic: 'https://reddnbre.github.io/empireclick-assets/Castle.glb',
         Legendary: 'https://reddnbre.github.io/empireclick-assets/LargeCastle.glb',
         Elite: 'https://reddnbre.github.io/empireclick-assets/Colosseum.glb'
       };

             // Make renderModelOnPlot globally accessible
       window.renderModelOnPlot = function(plotElement, rarity) {
         console.log('=== renderModelOnPlot START ===');
         console.log('Plot element:', plotElement);
         console.log('Rarity:', rarity);
         
         // 🧼 Step 1: Remove any old content from the plot
         plotElement.innerHTML = ''; // Destroys old text, tags, previous models
         console.log('Step 1: Cleared plot content');

         // 🛡️ Step 2: Prevent double-rendering
         if (plotElement.querySelector('canvas')) {
           console.log('Step 2: Canvas already exists, returning');
           return;
         }

         // 🎯 Step 3: Setup canvas
         const canvas = document.createElement('canvas');
         canvas.style.width = '100%';
         canvas.style.height = '100%';
         plotElement.appendChild(canvas);
         console.log('Step 3: Canvas created and appended');

         // 🧠 Scene + Camera
         const scene = new THREE.Scene();
         const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
         camera.position.set(5, 5, 10);
         console.log('Step 4: Scene and camera created');

         const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
         renderer.setSize(plotElement.clientWidth, plotElement.clientHeight);
         console.log('Step 5: Renderer created, size:', plotElement.clientWidth, 'x', plotElement.clientHeight);

         // 🎮 Controls
         const controls = new THREE.OrbitControls(camera, renderer.domElement);
         controls.enableDamping = true;
         controls.enableZoom = false;
         console.log('Step 6: OrbitControls created');

         // 💡 Lighting
         scene.add(new THREE.AmbientLight(0xffffff, 1.2));
         const light = new THREE.DirectionalLight(0xffffff, 1);
         light.position.set(5, 10, 7.5);
         scene.add(light);
         console.log('Step 7: Lighting added');

         // 🔗 Load model
         const loader = new THREE.GLTFLoader();
         let url = modelURLs[rarity];
         if (Array.isArray(url)) {
           url = url[Math.floor(Math.random() * url.length)];
         }
         console.log('Step 8: Loading model from URL:', url);

         loader.load(url, 
           // Success callback
           gltf => {
             console.log('Step 9: Model loaded successfully');
             const model = gltf.scene;

             // 🔄 Auto-center and scale
             const box = new THREE.Box3().setFromObject(model);
             const size = new THREE.Vector3();
             const center = new THREE.Vector3();
             box.getSize(size);
             box.getCenter(center);

             const scale = 5 / Math.max(size.x, size.y, size.z);
             model.scale.setScalar(scale);
             model.position.x -= center.x * scale;
             model.position.y -= center.y * scale;
             model.position.z -= center.z * scale;
             model.rotation.y = Math.PI / 4; // Initial rotation

             scene.add(model);
             console.log('Step 10: Model added to scene');
           },
           // Progress callback
           (progress) => {
             console.log('Loading progress:', (progress.loaded / progress.total * 100) + '%');
           },
           // Error callback
           (error) => {
             console.error('Error loading model:', error);
           }
         );

         // 🔁 Animation loop
         function animate() {
           requestAnimationFrame(animate);
           controls.update();

           // Slow rotation
           const modelGroup = scene.children.find(child => child.type === 'Group');
           if (modelGroup) modelGroup.rotation.y += 0.005;

           renderer.render(scene, camera);
         }
         animate();
         console.log('Step 11: Animation loop started');
         console.log('=== renderModelOnPlot END ===');
       };
    </script>
</body>
</html> 